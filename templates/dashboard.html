<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for MTM vs Day Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Theme Variables */
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
            --sidebar-bg: #3a3b45;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        /* Dark Theme */
        .dark-theme {
            --primary-color: #3758e6;
            --secondary-color: #adb5bd;
            --success-color: #17a673;
            --info-color: #2c9faf;
            --warning-color: #d4a017;
            --danger-color: #c82333;
            --light-color: #212529;
            --dark-color: #adb5bd;
            --sidebar-bg: #212529;
            --card-bg: #343a40;
            --text-color: #e9ecef;
        }

        body {
            background-color: var(--light-color);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Sidebar */
        .sidebar {
            min-height: 100vh;
            background-color: var(--sidebar-bg);
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 60px;
        }

        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 20px;
            font-size: 1.1rem;
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            border-bottom: 1px solid #e3e6f0;
            padding: 10px 20px;
            position: fixed;
            width: calc(100% - 250px);
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        /* Theme Toggle */
        .theme-toggle {
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* DTE Buttons */
        .dte-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .dte-button {
            border-radius: 5px;
            transition: all 0.3s;
            padding: 8px 16px;
        }

        .dte-button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 20px;
            transition: transform 0.3s;
            position: relative;
            z-index: 1;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            margin: 0;
        }

        /* Stat Cards */
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            color: #fff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #17a673);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #d4a017);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card h3 {
            font-size: 1.5rem;
            margin: 0;
        }

        .stat-card p {
            font-size: 0.9rem;
            margin: 0;
        }

        /* Tables */
        .table {
            margin-bottom: 0;
            color: var(--text-color);
        }

        .table th {
            background-color: var(--primary-color);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .table td {
            padding: 12px;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .scrollable-table-container {
            max-height: 300px;
            overflow-y: auto;
            position: relative;
        }

        .scrollable-user-table-container {
            max-height: 200px;
            overflow-y: auto;
            position: relative;
        }

        .user-table th, .user-table td {
            padding: 12px;
            text-align: left;
            min-width: 120px;
        }

        /* Filters */
        .filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .form-select, .btn {
            border-radius: 5px;
            transition: all 0.3s;
        }

        .form-select:focus, .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Server Filter Dropdown */
        .server-filter-dropdown {
            max-height: 300px;
            overflow-y: auto;
            width: 200px;
            z-index: 1050;
        }

        .server-checkbox {
            display: block;
            padding: 5px 10px;
        }

        .server-filter-button {
            min-width: 150px;
            text-align: left;
        }

        .dropdown-menu {
            padding: 0;
            z-index: 1050;
        }

        /* Badges */
        .badge {
            font-size: 0.9rem;
            padding: 5px 10px;
        }

        /* Export Button */
        .export-btn {
            margin-left: 10px;
        }

        /* Loading Spinner */
        #loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            display: none;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                width: 100%;
            }

            .stat-card {
                margin-bottom: 15px;
            }

            .filter-container {
                flex-wrap: wrap;
            }

            .server-filter-button {
                width: 100%;
            }

            .dte-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="/">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
        </ul>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>User Dashboard</h1>
        <div>
            <i class="fas fa-sun theme-toggle" id="theme-toggle"></i>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-top: 60px;">
        <!-- Loading Spinner -->
        <div id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- DTE Filter Buttons -->
        <div class="dte-buttons">
            <button class="btn btn-outline-primary dte-button {% if not dte_filter %}active{% endif %}" onclick="updateDTEFilter('Overall')">Overall</button>
            <button class="btn btn-outline-primary dte-button {% if dte_filter == '0' %}active{% endif %}" onclick="updateDTEFilter('0')">DTE0</button>
            <button class="btn btn-outline-primary dte-button {% if dte_filter == '1' %}active{% endif %}" onclick="updateDTEFilter('1')">DTE1</button>
        </div>

        {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% else %}
            <!-- Summary Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Summary ({{ date_display }})</h5>
                    <div>
                        <select id="timePeriodFilter" class="form-select" onchange="updateTimePeriod()">
                            <option value="Last Day" {% if time_period == 'Last Day' %}selected{% endif %}>Last Day</option>
                            <option value="Yesterday" {% if time_period == 'Yesterday' %}selected{% endif %}>Yesterday</option>
                            <option value="Today" {% if time_period == 'Today' %}selected{% endif %}>Today</option>
                            <option value="Last Week" {% if time_period == 'Last Week' %}selected{% endif %}>Last Week</option>
                            <option value="Last Month" {% if time_period == 'Last Month' %}selected{% endif %}>Last Month</option>
                            <option value="6 Months" {% if time_period == '6 Months' %}selected{% endif %}>6 Months</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card" data-bs-toggle="tooltip" title="Total number of unique users">
                                <i class="fas fa-users"></i>
                                <h3>{{ num_users }}</h3>
                                <p>Total Unique Users</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card success" data-bs-toggle="tooltip" title="Total number of unique algorithms">
                                <i class="fas fa-cogs"></i>
                                <h3>{{ num_algos }}</h3>
                                <p>Total Unique Algos</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card warning" data-bs-toggle="tooltip" title="Total number of unique servers">
                                <i class="fas fa-server"></i>
                                <h3>{{ unique_server_count }}</h3>
                                <p>Total Unique Servers</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card danger" data-bs-toggle="tooltip" title="Total MTM / Total Allocation (%)">
                                <i class="fas fa-chart-line"></i>
                                <h3>{{ total_return_percent }}%</h3>
                                <p>Total Return %</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total MTM Card with Independent Filters -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Total MTM ({{ date_display }})</h5>
                    <div class="filter-container">
                        <select id="userIdFilter" class="form-select" onchange="updateTotalMTMFilters()">
                            <option value="All Users" {% if selected_user_id == 'All Users' %}selected{% endif %}>All Users</option>
                            {% for user_id in all_user_ids %}
                                <option value="{{ user_id }}" {% if selected_user_id == user_id %}selected{% endif %}>{{ user_id }}</option>
                            {% endfor %}
                        </select>
                        <select id="totalMTMAlgoFilter" class="form-select">
                            <option value="All Algos" {% if total_mtm_algo == 'All Algos' %}selected{% endif %}>All Algos</option>
                            {% for algo in unique_algos %}
                                <option value="{{ algo }}" {% if total_mtm_algo == algo %}selected{% endif %}>{{ algo }}</option>
                            {% endfor %}
                        </select>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary server-filter-button dropdown-toggle" type="button" id="totalMTMServerFilterButton" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if total_mtm_servers %}
                                    {{ total_mtm_servers|join(', ') }}
                                {% else %}
                                    All Servers
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu server-filter-dropdown" id="totalMTMServerDropdown" aria-labelledby="totalMTMServerFilterButton">
                                <!-- Populated dynamically via JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="stat-card" data-bs-toggle="tooltip" title="Total Mark-to-Market value for selected user(s), algo, and server(s)">
                                <i class="fas fa-money-bill-wave"></i>
                                <h3>{{ total_mtm_value }}</h3>
                                <p>Total MTM</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Overview Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Performance Overview ({{ date_display }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>MTM vs Day</h6>
                            <div class="chart-container">
                                <canvas id="mtmVsDayChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="stat-card success" data-bs-toggle="tooltip" title="Percentage of days with positive MTM">
                                        <i class="fas fa-percentage"></i>
                                        <h3>{{ win_rate }}%</h3>
                                        <p>Win Rate</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="stat-card warning" data-bs-toggle="tooltip" title="Gross Profits / Gross Losses">
                                        <i class="fas fa-balance-scale"></i>
                                        <h3>{{ profit_factor }}</h3>
                                        <p>Profit Factor</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Insights Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Trading Insights ({{ date_display }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6">
                            <div class="stat-card danger" data-bs-toggle="tooltip" title="Day with the lowest total MTM">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>{{ worst_trading_day.mtm if worst_trading_day else 'N/A' }}</h3>
                                <p>Worst Trading Day<br>({{ worst_trading_day.date if worst_trading_day else 'N/A' }})</p>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top/Least Performing Users Card -->
            <div class="card" style="max-width: 1400px; margin: 0 auto;">
                <div class="card-header">
                    <h5 class="card-title">Top and Least Performing Users (Return Ratio) ({{ date_display }})</h5>
                    <div class="filter-container">
                        <select id="topLeastAlgoFilter" class="form-select">
                            <option value="All Algos" {% if top_least_algo == 'All Algos' %}selected{% endif %}>All Algos</option>
                            {% for algo in unique_algos %}
                                <option value="{{ algo }}" {% if top_least_algo == algo %}selected{% endif %}>{{ algo }}</option>
                            {% endfor %}
                        </select>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary server-filter-button dropdown-toggle" type="button" id="topLeastServerFilterButton" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if top_least_servers %}
                                    {{ top_least_servers|join(', ') }}
                                {% else %}
                                    All Servers
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu server-filter-dropdown" id="topLeastServerDropdown" aria-labelledby="topLeastServerFilterButton">
                                <!-- Populated dynamically via JavaScript -->
                            </ul>
                        </div>
                        <button class="btn btn-outline-success export-btn" onclick="exportTableToCSV('top-least-users', 'Top_Least_Users.csv')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Top 20% Users <span class="badge bg-primary">{{ top_users_count }}</span></h6>
                            <div class="scrollable-user-table-container">
                                <table class="table table-striped table-hover user-table">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Algo</th>
                                            <th>Server</th>
                                            <th>Return Ratio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in top_users %}
                                            <tr>
                                                <td>{{ user.user_id }}</td>
                                                <td>{{ user.algo }}</td>
                                                <td>{{ user.server }}</td>
                                                <td>{{ user['Return Ratio'] }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Least 20% Users <span class="badge bg-danger">{{ least_users_count }}</span></h6>
                            <div class="scrollable-user-table-container">
                                <table class="table table-striped table-hover user-table">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Algo</th>
                                            <th>Server</th>
                                            <th>Return Ratio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in least_users %}
                                            <tr>
                                                <td>{{ user.user_id }}</td>
                                                <td>{{ user.algo }}</td>
                                                <td>{{ user.server }}</td>
                                                <td>{{ user['Return Ratio'] }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Report Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Detailed Report ({{ date_display }})</h5>
                    <button class="btn btn-outline-success export-btn" onclick="exportTableToCSV('detailed-report', 'Detailed_Report.csv')">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                <div class="card-body">
                    <div class="scrollable-table-container">
                        <table class="table table-striped table-hover table-bordered" id="detailed-report">
                            <thead>
                                <tr>
                                    <th>ALGO</th>
                                    <th>SERVER</th>
                                    <th>No. of Users</th>
                                    <th>Sum of ALLOCATION</th>
                                    <th>Sum of MTM (All)</th>
                                    <th>Return Ratio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in final_df %}
                                    <tr>
                                        <td>{{ row.ALGO }}</td>
                                        <td>{{ row.SERVER }}</td>
                                        <td>{{ row['No. of Users'] }}</td>
                                        <td>{{ row['Sum of ALLOCATION'] }}</td>
                                        <td>{{ row['Sum of MTM (All)'] }}</td>
                                        <td>{{ row['Return Ratio'] }}</td>
                                    </tr>
                                {% endfor %}
                                <tr class="table-primary">
                                    <td>{{ grand_total.ALGO }}</td>
                                    <td>{{ grand_total.SERVER }}</td>
                                    <td>{{ grand_total['No. of Users'] }}</td>
                                    <td>{{ grand_total['Sum of ALLOCATION'] }}</td>
                                    <td>{{ grand_total['Sum of MTM (All)'] }}</td>
                                    <td>{{ grand_total['Return Ratio'] }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            if (document.body.classList.contains('dark-theme')) {
                themeToggle.classList.remove('fa-sun');
                themeToggle.classList.add('fa-moon');
            } else {
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
            }
        });

        // Show Loading Spinner on Filter Change
        function showLoading() {
            document.getElementById('loading-spinner').style.display = 'block';
        }

        // Algo to Servers mapping from backend
        const algoToServers = {{ algo_to_servers | tojson }};

        // Function to update Server dropdown options based on selected Algo
        function updateServerDropdown(algoSelectId, serverDropdownId, serverButtonId, selectedServers) {
            const selectedAlgo = document.getElementById(algoSelectId).value;
            const serverDropdown = document.getElementById(serverDropdownId);
            const serverButton = document.getElementById(serverButtonId);

            // Clear existing options
            serverDropdown.innerHTML = '';

            // Get servers for the selected algo
            const servers = algoToServers[selectedAlgo] || [];

            if (servers.length === 0) {
                serverDropdown.innerHTML = '<li class="server-checkbox"><span>No Servers Available</span></li>';
                serverButton.textContent = 'No Servers';
                return;
            }

            // Add "All Servers" option
            const allServersLi = document.createElement('li');
            allServersLi.className = 'server-checkbox';
            allServersLi.innerHTML = `
                <input type="checkbox" id="${algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-all' : 'top-least-server-all'}" value="All Servers" ${selectedServers.length === 0 ? 'checked' : ''}>
                <label for="${algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-all' : 'top-least-server-all'}">All Servers</label>
            `;
            serverDropdown.appendChild(allServersLi);

            // Add server options
            servers.forEach(server => {
                const isChecked = selectedServers.includes(server);
                const li = document.createElement('li');
                li.className = 'server-checkbox';
                li.innerHTML = `
                    <input type="checkbox" id="${algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-' : 'top-least-server-'}${server}" value="${server}" ${isChecked ? 'checked' : ''}>
                    <label for="${algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-' : 'top-least-server-'}${server}">${server}</label>
                `;
                serverDropdown.appendChild(li);
            });

            // Update button text
            if (selectedServers.length > 0) {
                serverButton.textContent = selectedServers.join(', ');
            } else {
                serverButton.textContent = 'All Servers';
            }

            // Add event listeners to checkboxes
            const allServersCheckbox = document.getElementById(algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-all' : 'top-least-server-all');
            const serverCheckboxes = serverDropdown.querySelectorAll(`input[type="checkbox"]:not(#${algoSelectId === 'totalMTMAlgoFilter' ? 'total-mtm-server-all' : 'top-least-server-all'})`);

            allServersCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    serverCheckboxes.forEach(cb => cb.checked = false);
                    serverButton.textContent = 'All Servers';
                }
                if (algoSelectId === 'totalMTMAlgoFilter') {
                    updateTotalMTMFilters();
                } else {
                    updateTopLeastFilters();
                }
            });

            serverCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const selected = Array.from(serverCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
                    allServersCheckbox.checked = selected.length === 0;
                    serverButton.textContent = selected.length > 0 ? selected.join(', ') : 'All Servers';
                    if (algoSelectId === 'totalMTMAlgoFilter') {
                        updateTotalMTMFilters();
                    } else {
                        updateTopLeastFilters();
                    }
                });
            });
        }

        // Update DTE Filter
        function updateDTEFilter(dteValue) {
            showLoading();
            const totalMTMAlgo = document.getElementById('totalMTMAlgoFilter').value;
            const totalMTMServers = getSelectedServers('totalMTMServerFilterButton');
            const topLeastAlgo = document.getElementById('topLeastAlgoFilter').value;
            const topLeastServers = getSelectedServers('topLeastServerFilterButton');
            const userId = document.getElementById('userIdFilter').value;
            const timePeriod = document.getElementById('timePeriodFilter').value;

            let url = `/?time_period=${encodeURIComponent(timePeriod)}&user_id=${encodeURIComponent(userId)}&total_mtm_algo=${encodeURIComponent(totalMTMAlgo)}&top_least_algo=${encodeURIComponent(topLeastAlgo)}`;
            if (totalMTMServers.length > 0) {
                url += totalMTMServers.map(server => `&total_mtm_servers=${encodeURIComponent(server)}`).join('');
            }
            if (topLeastServers.length > 0) {
                url += topLeastServers.map(server => `&top_least_servers=${encodeURIComponent(server)}`).join('');
            }
            if (dteValue !== 'Overall') {
                url += `&dte_filter=${encodeURIComponent(dteValue)}`;
            }
            console.log(`DTE Filter - Navigating to URL: ${url}`);
            window.location.href = url;
        }

        // Update Total MTM Filters (Independent)
        function updateTotalMTMFilters() {
            showLoading();
            const totalMTMAlgo = document.getElementById('totalMTMAlgoFilter').value;
            const totalMTMServers = getSelectedServers('totalMTMServerFilterButton');
            const topLeastAlgo = document.getElementById('topLeastAlgoFilter').value;
            const topLeastServers = getSelectedServers('topLeastServerFilterButton');
            const userId = document.getElementById('userIdFilter').value;
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const dteFilter = '{{ dte_filter if dte_filter else "Overall" }}';

            let url = `/?time_period=${encodeURIComponent(timePeriod)}&user_id=${encodeURIComponent(userId)}&total_mtm_algo=${encodeURIComponent(totalMTMAlgo)}&top_least_algo=${encodeURIComponent(topLeastAlgo)}`;
            if (totalMTMServers.length > 0) {
                url += totalMTMServers.map(server => `&total_mtm_servers=${encodeURIComponent(server)}`).join('');
            }
            if (topLeastServers.length > 0) {
                url += topLeastServers.map(server => `&top_least_servers=${encodeURIComponent(server)}`).join('');
            }
            if (dteFilter !== 'Overall') {
                url += `&dte_filter=${encodeURIComponent(dteFilter)}`;
            }
            console.log(`Total MTM Filter - Navigating to URL: ${url}`);
            window.location.href = url;
        }

        // Update Top/Least Performing Users Filters (Affects Detailed Report)
        function updateTopLeastFilters() {
            showLoading();
            const totalMTMAlgo = document.getElementById('totalMTMAlgoFilter').value;
            const totalMTMServers = getSelectedServers('totalMTMServerFilterButton');
            const topLeastAlgo = document.getElementById('topLeastAlgoFilter').value;
            const topLeastServers = getSelectedServers('topLeastServerFilterButton');
            const userId = document.getElementById('userIdFilter').value;
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const dteFilter = '{{ dte_filter if dte_filter else "Overall" }}';

            let url = `/?time_period=${encodeURIComponent(timePeriod)}&user_id=${encodeURIComponent(userId)}&total_mtm_algo=${encodeURIComponent(totalMTMAlgo)}&top_least_algo=${encodeURIComponent(topLeastAlgo)}`;
            if (totalMTMServers.length > 0) {
                url += totalMTMServers.map(server => `&total_mtm_servers=${encodeURIComponent(server)}`).join('');
            }
            if (topLeastServers.length > 0) {
                url += topLeastServers.map(server => `&top_least_servers=${encodeURIComponent(server)}`).join('');
            }
            if (dteFilter !== 'Overall') {
                url += `&dte_filter=${encodeURIComponent(dteFilter)}`;
            }
            console.log(`Top/Least Filter - Navigating to URL: ${url}`);
            window.location.href = url;
        }

        // Update Time Period Filter (Global)
        function updateTimePeriod() {
            showLoading();
            const totalMTMAlgo = document.getElementById('totalMTMAlgoFilter').value;
            const totalMTMServers = getSelectedServers('totalMTMServerFilterButton');
            const topLeastAlgo = document.getElementById('topLeastAlgoFilter').value;
            const topLeastServers = getSelectedServers('topLeastServerFilterButton');
            const userId = document.getElementById('userIdFilter').value;
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const dteFilter = '{{ dte_filter if dte_filter else "Overall" }}';

            let url = `/?time_period=${encodeURIComponent(timePeriod)}&user_id=${encodeURIComponent(userId)}&total_mtm_algo=${encodeURIComponent(totalMTMAlgo)}&top_least_algo=${encodeURIComponent(topLeastAlgo)}`;
            if (totalMTMServers.length > 0) {
                url += totalMTMServers.map(server => `&total_mtm_servers=${encodeURIComponent(server)}`).join('');
            }
            if (topLeastServers.length > 0) {
                url += topLeastServers.map(server => `&top_least_servers=${encodeURIComponent(server)}`).join('');
            }
            if (dteFilter !== 'Overall') {
                url += `&dte_filter=${encodeURIComponent(dteFilter)}`;
            }
            console.log(`Time Period Filter - Navigating to URL: ${url}`);
            window.location.href = url;
        }

        function getSelectedServers(buttonId) {
            const allServersChecked = document.getElementById(buttonId === 'totalMTMServerFilterButton' ? 'total-mtm-server-all' : 'top-least-server-all')?.checked;
            if (allServersChecked) {
                return [];
            }
            const checkboxes = document.querySelectorAll(`#${buttonId} + .dropdown-menu .server-checkbox input[type="checkbox"]:not(#${buttonId === 'totalMTMServerFilterButton' ? 'total-mtm-server-all' : 'top-least-server-all'})`);
            return Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        // Initialize Server Dropdowns on Page Load
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Total MTM Server Dropdown
            const totalMTMSelectedServers = {{ total_mtm_servers | tojson }};
            updateServerDropdown('totalMTMAlgoFilter', 'totalMTMServerDropdown', 'totalMTMServerFilterButton', totalMTMSelectedServers);

            // Initialize Top/Least Server Dropdown
            const topLeastSelectedServers = {{ top_least_servers | tojson }};
            updateServerDropdown('topLeastAlgoFilter', 'topLeastServerDropdown', 'topLeastServerFilterButton', topLeastSelectedServers);

            // Add event listeners for Algo changes
            document.getElementById('totalMTMAlgoFilter').addEventListener('change', function () {
                updateServerDropdown('totalMTMAlgoFilter', 'totalMTMServerDropdown', 'totalMTMServerFilterButton', []);
                updateTotalMTMFilters();
            });

            document.getElementById('topLeastAlgoFilter').addEventListener('change', function () {
                updateServerDropdown('topLeastAlgoFilter', 'topLeastServerDropdown', 'topLeastServerFilterButton', []);
                updateTopLeastFilters();
            });

            // Prevent dropdown from closing when clicking inside
            document.querySelectorAll('.server-filter-dropdown').forEach(dropdown => {
                dropdown.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            });

            // Export Table to CSV
            function exportTableToCSV(tableId, filename) {
                const table = document.getElementById(tableId);
                let csv = [];
                const rows = table.querySelectorAll('tr');

                for (const row of rows) {
                    const cols = row.querySelectorAll('td, th');
                    const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`).join(',');
                    csv.push(rowData);
                }

                const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
                const downloadLink = document.createElement('a');
                downloadLink.download = filename;
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }

            // Initialize Tooltips and Chart
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            const ctx = document.getElementById('mtmVsDayChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ mtm_dates | tojson }},
                    datasets: [{
                        label: 'Total MTM',
                        data: {{ mtm_values | tojson }},
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'MTM'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>